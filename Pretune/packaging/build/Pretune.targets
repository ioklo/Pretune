<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <PretuneAssemblyPath>$(MSBuildThisFileDirectory)..\tools\Pretune.dll</PretuneAssemblyPath>
    <PretuneGeneratedPath>Generated</PretuneGeneratedPath>
  </PropertyGroup>

  <ItemGroup>
    <PretuneItem Include="@(Compile)" Exclude="$(PretuneGeneratedPath)\**\*.cs"></PretuneItem>    
  </ItemGroup>
  
  <!--<Target Name="ClearPreturn" BeforeTargets="Pretune">
    --><!-- a.cs / a.generated.cs --><!--
    <Delete Condition="Exists('%(Compile.filename)') AND Exists('%(Compile.filename)')"
  </Target>-->

  <!--<Target Name="Pretune2" BeforeTargets="BeforeCompile">
    <Message Importance="high" Text="PretuneAssemblyPath: $(PretuneAssemblyPath)" />
    <Message Importance="high" Text="MSBuildBinPath: $(MSBuildBinPath)" />
    <Message Importance="high" Text="MSBuildRuntimeType: $(MSBuildRuntimeType)" />
    <Message Importance="high" Text="MSBuildProjectDirectory: $(MSBuildProjectDirectory)" />
  </Target>-->

    <!--
      'a/b/c.cs' 
      => ['Generated', 'a/b', 'c' + '.g.cs' ] 
      => [$(PretuneGeneratedPath), [System.IO.Path]::GetDirectoryName(), %(filename), '.g.cs']
      <PretuneGeneratedItem 
    -->
  
  <Target Name="PretuneClean" BeforeTargets="BeforeClean">
    <PropertyGroup>
      <PretuneGeneratedPath></PretuneGeneratedPath>
    </PropertyGroup>
    <Error Condition="'$(PretuneGeneratedPath)' == ''" />
    <RemoveDir Directories="$(PretuneGeneratedPath)" Condition="'$(PretuneGeneratedPath)' != ''"/>
  </Target>

  <Target Name="PretuneCompile" BeforeTargets="BeforeCompile"          
          Inputs="@(PretuneItem)"
          Outputs="@(PretuneItem->'$(PretuneGeneratedPath)\$([System.IO.Path]::GetDirectoryName(`%(Identity)`))\%(Filename).g.cs')" Condition="'$(DesignTimeBuild)'!='true'">

    <PropertyGroup>
      <PretuneResponseFile>$(IntermediateOutputPath)\Pretune.rsp</PretuneResponseFile>
      <PretuneOutputsFile>$(IntermediateOutputPath)Pretune.outputs</PretuneOutputsFile>
    </PropertyGroup>

    <MakeDir Directories="$(IntermediateOutputPath)" />
    <WriteLinesToFile Overwrite="true" File="$(PretuneResponseFile)" Lines="$(PretuneGeneratedPath)" />
    <WriteLinesToFile File="$(PretuneResponseFile)" Lines="$(PretuneOutputsFile)" />
    <WriteLinesToFile File="$(PretuneResponseFile)" Lines="@(PretuneItem)" />
    <Exec Command="dotnet &quot;$(PretuneAssemblyPath)&quot; @$(PretuneResponseFile)"/>
    <ReadLinesFromFile File="$(PretuneOutputsFile)">
      <Output TaskParameter="Lines" ItemName="PretuneGeneratedItem"/>
    </ReadLinesFromFile>

    <ItemGroup>
      <!-- NOTICE: if an generated item has custom metadata, 'KeepDuplicates' doesn't work -->
      <Compile Include="@(PretuneGeneratedItem)" KeepDuplicates="False"/>
    </ItemGroup>
    
  </Target>
</Project>