<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <PretuneAssemblyPath>$(MSBuildThisFileDirectory)\..\tools\Pretune.dll</PretuneAssemblyPath>
    <PretuneGeneratedPath>Generated</PretuneGeneratedPath>
  </PropertyGroup>

  <ItemGroup>
    <PretuneItem Include="@(Compile)" Exclude="$(PretuneGeneratedPath)\**\*.cs"></PretuneItem>
  </ItemGroup>
  
  <!--<Target Name="ClearPreturn" BeforeTargets="Pretune">
    --><!-- a.cs / a.generated.cs --><!--
    <Delete Condition="Exists('%(Compile.filename)') AND Exists('%(Compile.filename)')"
  </Target>-->

  <!--<Target Name="Pretune2" BeforeTargets="BeforeCompile">
    <Message Importance="high" Text="PretuneAssemblyPath: $(PretuneAssemblyPath)" />
    <Message Importance="high" Text="MSBuildBinPath: $(MSBuildBinPath)" />
    <Message Importance="high" Text="MSBuildRuntimeType: $(MSBuildRuntimeType)" />
    <Message Importance="high" Text="MSBuildProjectDirectory: $(MSBuildProjectDirectory)" />
  </Target>-->

  <Target Name="Pretune" BeforeTargets="BeforeCompile"          
          Inputs="@(PretuneItem)"
          Outputs="@(PretuneItem->'$(PretuneGeneratedPath)\%(Identity)')" Condition="'$(DesignTimeBuild)'!='true'">

    <PropertyGroup>
      <PretuneResponseFile>$(IntermediateOutputPath)\Pretune.rsp</PretuneResponseFile>
      <PretuneOutputsFile>$(IntermediateOutputPath)Pretune.outputs</PretuneOutputsFile>
    </PropertyGroup>

    <MakeDir Directories="$(IntermediateOutputPath)" />
    <WriteLinesToFile Overwrite="true" File="$(PretuneResponseFile)" Lines="$(PretuneGeneratedPath)" />
    <WriteLinesToFile File="$(PretuneResponseFile)" Lines="$(PretuneOutputsFile)" />
    <WriteLinesToFile File="$(PretuneResponseFile)" Lines="@(PretuneItem)" />
    <Exec Command="dotnet &quot;$(PretuneAssemblyPath)&quot; @$(PretuneResponseFile)"/>
    <ReadLinesFromFile File="$(PretuneOutputsFile)">
      <Output TaskParameter="Lines" ItemName="PretuneGeneratedItem"/>
    </ReadLinesFromFile>

    <ItemGroup>
      <!--중복이 발생할 수 있지만, KeepDuplicates만 꺼져있으면 안심 -->
      <Compile Include="@(PretuneGeneratedItem)" />
    </ItemGroup>
    
  </Target>
</Project>