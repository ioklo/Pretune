<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <PretuneAssemblyPath>$(MSBuildThisFileDirectory)..\tools\Pretune.dll</PretuneAssemblyPath>
    <PretuneGeneratedPath>PretuneGenerated</PretuneGeneratedPath>
  </PropertyGroup>

  <ItemGroup>
    <PretuneItem Include="@(Compile)" Exclude="$(PretuneGeneratedPath)\**\*.cs"></PretuneItem>    
  </ItemGroup>  
  
  <Target Name="PretuneClean" BeforeTargets="BeforeClean">
    <Error Condition="'$(PretuneGeneratedPath)' == ''" Text="BE CAREFUL!, PretuneGeneratedPath SHOULD NOT be empty, especially on CLEANING" />
    <RemoveDir Directories="$(PretuneGeneratedPath)" Condition="'$(PretuneGeneratedPath)' != ''"/>
  </Target>

  <Target Name="PretuneCompile" BeforeTargets="BeforeCompile"          
          Inputs="@(PretuneItem)"
          Outputs="@(PretuneItem->'$(PretuneGeneratedPath)\$([System.IO.Path]::GetDirectoryName(`%(Identity)`))\%(Filename).g.cs')" Condition="'$(DesignTimeBuild)'!='true'">

    <PropertyGroup>
      <PretuneResponseFile>$(IntermediateOutputPath)\Pretune.rsp</PretuneResponseFile>
      <PretuneOutputsFile>$(IntermediateOutputPath)Pretune.outputs</PretuneOutputsFile>
    </PropertyGroup>

    <MakeDir Directories="$(IntermediateOutputPath)" />
    <WriteLinesToFile Overwrite="true" File="$(PretuneResponseFile)" Lines="$(PretuneGeneratedPath)" />
    <WriteLinesToFile File="$(PretuneResponseFile)" Lines="$(PretuneOutputsFile)" />
    <WriteLinesToFile File="$(PretuneResponseFile)" Lines="@(PretuneItem)" />
    <WriteLinesToFile File="$(PretuneResponseFile)" Lines="-r" />
    <WriteLinesToFile File="$(PretuneResponseFile)" Lines="@(ReferencePathWithRefAssemblies)" />
    <Exec Command="dotnet &quot;$(PretuneAssemblyPath)&quot; @$(PretuneResponseFile)"/>
    <ReadLinesFromFile File="$(PretuneOutputsFile)">
      <Output TaskParameter="Lines" ItemName="PretuneGeneratedItem"/>
    </ReadLinesFromFile>

    <ItemGroup>
      <!-- NOTICE: if an generated items have different metadata, 'KeepDuplicates=False' doesn't work -->
      <Compile Include="@(PretuneGeneratedItem)" KeepDuplicates="False"/>
    </ItemGroup>
    
  </Target>
</Project>